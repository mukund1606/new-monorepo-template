# Use official Bun runtime as base image
FROM oven/bun:1

# Set working directory
WORKDIR /app

# Copy workspace configuration and lockfile
COPY package.json bun.lock turbo.json ./

# Copy entire workspace structure to maintain proper workspace resolution
COPY apps/ ./apps/
COPY packages/ ./packages/
COPY tooling/ ./tooling/
COPY scripts/ ./scripts/

# Install dependencies (this will install all workspace dependencies)
RUN bun install

# Build the web app (skip env validation during build)
RUN DOCKER_BUILD=true bunx turbo run build --filter @acme/web

# Expose port
EXPOSE 3001

# Set environment
ENV NODE_ENV=production
ENV PORT=3001

# Start the web server
CMD ["bun", "--cwd", "apps/web", "start"]
